name: Function Bay E2E Tests

on:
  push:
    branches: [main, feature/**]
    paths:
      - 'service/**'
      - 'packages/**'
      - 'clients/**'
      - 'package.json'
      - 'bun.lock'
      - '.github/workflows/function-bay-e2e-tests.yml'
  pull_request:
    branches: [main]
    paths:
      - 'service/**'
      - 'packages/**'
      - 'clients/**'
      - 'package.json'
      - 'bun.lock'

jobs:
  e2e-tests:
    name: Run Function Bay E2E Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Start Docker services
        env:
          RUN_ID: ${{ github.run_id }}
        run: |
          cd service
          docker compose -p function-bay-ci-$RUN_ID -f docker-compose.dev.yml --env-file .env.ci --profile infra --profile service up -d --build

      - name: Wait for services to be ready
        env:
          RUN_ID: ${{ github.run_id }}
        run: |
          cd service
          echo "Waiting for all services to be ready..."
          services=(
            function-bay-postgres
            function-bay-redis
            function-bay-object-storage
            function-bay-forge
            function-bay-service
          )
          for i in {1..60}; do
            all_ready=true
            for service in "${services[@]}"; do
              status=$(docker inspect -f '{{if .State.Health}}{{.State.Health.Status}}{{else}}{{.State.Status}}{{end}}' "$service" 2>/dev/null || echo "missing")
              if [ "$status" != "healthy" ] && [ "$status" != "running" ]; then
                all_ready=false
                break
              fi
            done
            if [ "$all_ready" = true ]; then
              break
            fi
            sleep 5
          done
          if [ "$all_ready" != true ]; then
            echo "Timed out waiting for services to be ready."
            docker compose -p function-bay-ci-$RUN_ID -f docker-compose.dev.yml --env-file .env.ci ps
            echo "=== Unready Service Logs ==="
            for service in "${services[@]}"; do
              status=$(docker inspect -f '{{if .State.Health}}{{.State.Health.Status}}{{else}}{{.State.Status}}{{end}}' "$service" 2>/dev/null || echo "missing")
              if [ "$status" != "healthy" ] && [ "$status" != "running" ]; then
                echo "--- $service ($status) ---"
                docker logs "$service" --tail=200 || true
              fi
            done
            exit 1
          fi
          echo "Services are ready!"
          docker compose -p function-bay-ci-$RUN_ID -f docker-compose.dev.yml --env-file .env.ci ps

      - name: Run E2E tests
        run: |
          docker exec function-bay-service sh -c "cd /app && bun run test -- --mode ci"

      - name: Collect logs on failure
        if: failure()
        env:
          RUN_ID: ${{ github.run_id }}
        run: |
          cd service
          echo "=== Docker Compose Logs ==="
          docker compose -p function-bay-ci-$RUN_ID -f docker-compose.dev.yml --env-file .env.ci logs --tail=100

          echo "=== Service Container Logs ==="
          docker logs function-bay-service --tail=200

          echo "=== Service Status ==="
          docker compose -p function-bay-ci-$RUN_ID -f docker-compose.dev.yml --env-file .env.ci ps

      - name: Cleanup
        if: always()
        env:
          RUN_ID: ${{ github.run_id }}
        run: |
          cd service
          docker compose -p function-bay-ci-$RUN_ID -f docker-compose.dev.yml --env-file .env.ci down -v
