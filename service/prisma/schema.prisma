// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "./generated"
}

datasource db {
  provider = "postgresql"
}

generator json {
  provider = "prisma-json-types-generator"
}

model Instance {
  oid BigInt @id
  id  String @unique

  identifier String @unique
  name       String

  createdAt             DateTime               @default(now())
  runtimeForgeWorkflows RuntimeForgeWorkflow[]
  functions             Function[]
}

model Provider {
  oid BigInt @id
  id  String @unique

  identifier String @unique
  name       String

  createdAt DateTime @default(now())

  runtimes Runtime[]
}

model Runtime {
  oid BigInt @id
  id  String @unique

  identifier String @unique
  name       String

  providerOid BigInt
  provider    Provider @relation(fields: [providerOid], references: [oid])

  /// [RuntimeConfiguration]
  configuration Json

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  functions             Function[]
  runtimeForgeWorkflows RuntimeForgeWorkflow[]
  functionDeployments   FunctionDeployment[]
  functionVersions      FunctionVersion[]
}

model RuntimeForgeWorkflow {
  oid BigInt @id

  runtimeOid BigInt
  runtime    Runtime @relation(fields: [runtimeOid], references: [oid])

  instanceOid BigInt
  instance    Instance @relation(fields: [instanceOid], references: [oid])

  forgeWorkflowId        String
  forgeInstanceId        String
  forgeWorkflowVersionId String

  @@unique([runtimeOid, instanceOid])
}

enum FunctionStatus {
  active
  deleted
}

model Function {
  oid BigInt @id
  id  String @unique

  status FunctionStatus

  identifier String
  name       String

  currentVersionOid BigInt?
  currentVersion    FunctionVersion? @relation(fields: [currentVersionOid], references: [oid], name: "CurrentVersion")

  instanceOid BigInt
  instance    Instance @relation(fields: [instanceOid], references: [oid])

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  functionVersions    FunctionVersion[]
  functionDeployments FunctionDeployment[]
  runtime             Runtime?             @relation(fields: [runtimeOid], references: [oid])
  runtimeOid          BigInt?

  @@unique([identifier, instanceOid])
}

enum FunctionDeploymentStatus {
  pending
  running
  succeeded
  failed
}

model FunctionDeployment {
  oid    BigInt                   @id
  id     String                   @unique
  status FunctionDeploymentStatus

  identifier String
  name       String

  forgeRunId      String?
  forgeWorkflowId String?

  functionVersionOid BigInt?
  functionVersion    FunctionVersion? @relation(fields: [functionVersionOid], references: [oid])

  runtimeOid BigInt
  runtime    Runtime @relation(fields: [runtimeOid], references: [oid])

  functionOid BigInt
  function    Function @relation(fields: [functionOid], references: [oid])

  encryptedEnvironmentVariables String

  /// [FunctionConfiguration]
  configuration Json

  errorCode    String?
  errorMessage String?

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  steps FunctionDeploymentStep[]

  @@unique([identifier, functionOid])
}

enum FunctionDeploymentStepStatus {
  pending
  running
  succeeded
  failed
  canceled
}

enum FunctionDeploymentStepType {
  deploy
}

model FunctionDeploymentStep {
  oid BigInt @id
  id  String @unique

  status FunctionDeploymentStepStatus
  type   FunctionDeploymentStepType

  name   String
  output String

  functionDeploymentOid BigInt
  functionDeployment    FunctionDeployment @relation(fields: [functionDeploymentOid], references: [oid])

  createdAt DateTime  @default(now())
  startedAt DateTime?
  endedAt   DateTime?
}

enum FunctionVersionStatus {
  active
  deleted
}

model FunctionVersion {
  oid    BigInt                @id
  id     String                @unique
  status FunctionVersionStatus

  identifier String
  name       String

  functionOid BigInt
  function    Function @relation(fields: [functionOid], references: [oid])

  runtimeOid BigInt
  runtime    Runtime @relation(fields: [runtimeOid], references: [oid])

  /// [FunctionConfiguration]
  configuration Json

  /// [FunctionVersionProviderData]
  providerData Json

  /// [FunctionVersionManifest]
  manifest Json

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  functions           Function[]           @relation(name: "CurrentVersion")
  functionDeployments FunctionDeployment[]
  functionInvocations FunctionInvocation[]

  @@unique([identifier, functionOid])
}

enum FunctionInvocationStatus {
  succeeded
  failed
}

model FunctionInvocation {
  oid BigInt @id
  id  String @unique

  status FunctionInvocationStatus

  functionVersionOid BigInt
  functionVersion    FunctionVersion @relation(fields: [functionVersionOid], references: [oid])

  error Json
  logs  String

  computeTimeMs Int
  billedTimeMs  Int

  createdAt DateTime @default(now())
}
